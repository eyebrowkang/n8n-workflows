{
  "name": "WeatherOnCalendar Sharing",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [-1792, -560],
      "id": "d7ac8d47-1653-481d-a404-da5372d079cc",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "url": "https://api.openweathermap.org/data/3.0/onecall?lat=39.9042&lon=116.4074&exclude=minutely,hourly",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openWeatherMapApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [-1360, -432],
      "id": "564b16f2-0ae7-4c2b-97f0-de4b7cf64c60",
      "name": "HTTP Request",
      "credentials": {
        "openWeatherMapApi": {
          "id": "DJxEmk4IwxoGvSaR",
          "name": "OpenWeatherMap account"
        }
      }
    },
    {
      "parameters": {
        "language": "pythonNative",
        "pythonCode": "\"\"\"\nn8n Code in Python\n\nWeather to CalDAV\nä» OpenWeatherMap JSON æ•°æ®æå–å¤©æ°”ä¿¡æ¯å¹¶å†™å…¥ CalDAV æ—¥å†\nå‚è€ƒæ–‡æ¡£:\nhttps://openweathermap.org/api/one-call-3#current\nhttps://openweathermap.org/weather-conditions\n\nå…¶ä¸­ _items[0][\"json\"] ä¸ºå‰ä¸€æ­¥http requestçš„è¿”å›å€¼\n\"\"\"\n\nimport json\nimport hashlib\nfrom datetime import datetime, timedelta, date\nfrom zoneinfo import ZoneInfo\n\nimport caldav\nfrom icalendar import Calendar, Event\n\n# ============ é…ç½®åŒºåŸŸ ============\nCALDAV_URL = \"https://caldav.example.com/testuser\"  # CalDAV æœåŠ¡å™¨åœ°å€\nCALDAV_USERNAME = \"testuser\"\nCALDAV_PASSWORD = \"password123\"\nCALENDAR_NAME = \"Weather\"  # æ—¥å†åç§°ï¼Œä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º\n# ä¿ç•™å†å²å¤©æ°”æ•°æ®å¤©æ•°ï¼ˆé»˜è®¤ä¿ç•™è¿‡å» 7 å¤©ï¼›è®¾ä¸º 0 è¡¨ç¤ºä¸ä¿ç•™ï¼‰\nKEEP_PAST_DAYS = 7\n# å¤©æ°” emoji æ˜ å°„\nWEATHER_EMOJI = {\n    \"clear sky\": \"â˜€ï¸\",\n    \"few clouds\": \"ğŸŒ¤ï¸\",\n    \"scattered clouds\": \"â›…\",\n    \"broken clouds\": \"â˜ï¸\",\n    \"overcast clouds\": \"â˜ï¸\",\n    \"shower rain\": \"ğŸŒ¦ï¸\",\n    \"light rain\": \"ğŸŒ§ï¸\",\n    \"moderate rain\": \"ğŸŒ§ï¸\",\n    \"rain\": \"ğŸŒ§ï¸\",\n    \"heavy rain\": \"ğŸŒ§ï¸\",\n    \"thunderstorm\": \"â›ˆï¸\",\n    \"light snow\": \"ğŸŒ¨ï¸\",\n    \"snow\": \"â„ï¸\",\n    \"heavy snow\": \"â„ï¸\",\n    \"mist\": \"ğŸŒ«ï¸\",\n    \"fog\": \"ğŸŒ«ï¸\",\n    \"haze\": \"ğŸŒ«ï¸\",\n}\n\ndef kelvin_to_celsius(k: float) -> float:\n    \"\"\"å¼€å°”æ–‡è½¬æ‘„æ°åº¦\"\"\"\n    return k - 273.15\n\n\ndef get_weather_emoji(description: str) -> str:\n    \"\"\"æ ¹æ®å¤©æ°”æè¿°è·å– emoji\"\"\"\n    return WEATHER_EMOJI.get(description.lower(), \"ğŸŒ¡\")\n\n\ndef parse_weather_data(data: dict) -> list[dict]:\n    \"\"\"\n    è§£æ OpenWeatherMap JSON æ•°æ®\n    è¿”å›å¤©æ°”äº‹ä»¶åˆ—è¡¨\n    \"\"\"\n    events = []\n    tz = ZoneInfo(data[\"timezone\"])\n\n    # è§£æå½“å‰å¤©æ°” (today)\n    current = data[\"current\"]\n    current_dt = datetime.fromtimestamp(current[\"dt\"], tz=tz)\n    weather_info = current[\"weather\"][0]\n\n    events.append({\n        \"date\": current_dt.date(),\n        \"description\": weather_info[\"description\"],\n        \"emoji\": get_weather_emoji(weather_info[\"description\"]),\n        \"temp\": kelvin_to_celsius(current[\"temp\"]),\n        \"feels_like\": kelvin_to_celsius(current[\"feels_like\"]),\n        \"humidity\": current[\"humidity\"],\n        \"wind_speed\": current[\"wind_speed\"],\n        \"is_current\": True,\n        \"temp_min\": None,\n        \"temp_max\": None,\n        \"summary\": f\"å½“å‰: {weather_info['description']}\",\n        \"pop\": None,\n        \"snow\": current.get(\"snow\", {}).get(\"1h\"),\n        \"rain\": current.get(\"rain\", {}).get(\"1h\"),\n    })\n\n    # è§£ææœªæ¥å‡ å¤©å¤©æ°”\n    for day in data[\"daily\"]:\n        day_dt = datetime.fromtimestamp(day[\"dt\"], tz=tz)\n        weather_info = day[\"weather\"][0]\n\n        # è·³è¿‡ä»Šå¤©ï¼ˆå·²ç»ç”¨ current å¤„ç†ï¼‰\n        if day_dt.date() == current_dt.date():\n            continue\n\n        events.append({\n            \"date\": day_dt.date(),\n            \"description\": weather_info[\"description\"],\n            \"emoji\": get_weather_emoji(weather_info[\"description\"]),\n            \"temp\": kelvin_to_celsius(day[\"temp\"][\"day\"]),\n            \"feels_like\": kelvin_to_celsius(day[\"feels_like\"][\"day\"]),\n            \"temp_min\": kelvin_to_celsius(day[\"temp\"][\"min\"]),\n            \"temp_max\": kelvin_to_celsius(day[\"temp\"][\"max\"]),\n            \"humidity\": day[\"humidity\"],\n            \"wind_speed\": day[\"wind_speed\"],\n            \"is_current\": False,\n            \"summary\": day.get(\"summary\", weather_info[\"description\"]),\n            \"pop\": day.get(\"pop\"),  # é™æ°´æ¦‚ç‡\n            \"snow\": day.get(\"snow\"),\n            \"rain\": day.get(\"rain\"),\n        })\n\n    return events\n\n\ndef create_ical_event(weather: dict) -> Event:\n    \"\"\"åˆ›å»º iCalendar äº‹ä»¶\"\"\"\n    event = Event()\n\n    # ç”Ÿæˆå”¯ä¸€ UIDï¼ˆåŸºäºæ—¥æœŸï¼‰\n    uid = hashlib.md5(f\"weather-{weather['date']}\".encode()).hexdigest()\n    event.add(\"uid\", f\"{uid}@weather-calendar\")\n\n    # å…¨å¤©äº‹ä»¶\n    event.add(\"dtstart\", weather[\"date\"])\n    event.add(\"dtend\", weather[\"date\"] + timedelta(days=1))\n\n    # æ ‡é¢˜ï¼šemoji + æ¸©åº¦èŒƒå›´\n    if weather[\"temp_min\"] is not None and weather[\"temp_max\"] is not None:\n        title = f\"{weather['emoji']} {weather['temp_min']:.0f}Â°~{weather['temp_max']:.0f}Â°C\"\n    else:\n        title = f\"{weather['emoji']} {weather['temp']:.0f}Â°C\"\n    event.add(\"summary\", title)\n\n    # è¯¦ç»†æè¿°\n    desc_lines = [\n        f\"å¤©æ°”: {weather['description']}\",\n        f\"æ¸©åº¦: {weather['temp']:.1f}Â°C\",\n        f\"ä½“æ„Ÿ: {weather['feels_like']:.1f}Â°C\",\n    ]\n\n    if weather[\"temp_min\"] is not None:\n        desc_lines.append(f\"æœ€ä½/æœ€é«˜: {weather['temp_min']:.1f}Â°C / {weather['temp_max']:.1f}Â°C\")\n\n    desc_lines.extend([\n        f\"æ¹¿åº¦: {weather['humidity']}%\",\n        f\"é£é€Ÿ: {weather['wind_speed']} m/s\",\n    ])\n\n    if weather[\"pop\"] is not None:\n        desc_lines.append(f\"é™æ°´æ¦‚ç‡: {weather['pop'] * 100:.0f}%\")\n\n    if weather[\"snow\"]:\n        desc_lines.append(f\"é™é›ªé‡: {weather['snow']} mm\")\n\n    if weather[\"rain\"]:\n        desc_lines.append(f\"é™é›¨é‡: {weather['rain']} mm\")\n\n    desc_lines.append(f\"\\n{weather['summary']}\")\n\n    event.add(\"description\", \"\\n\".join(desc_lines))\n    event.add(\"dtstamp\", datetime.now())\n\n    return event\n\ndef _extract_event_date(ical_event) -> date | None:\n    dtstart = ical_event.get(\"dtstart\")\n    if not dtstart:\n        return None\n    if isinstance(dtstart, datetime):\n        return dtstart.date()\n    if isinstance(dtstart, date):\n        return dtstart\n    try:\n        dt_value = dtstart.dt\n    except Exception:\n        dt_value = None\n    else:\n        if isinstance(dt_value, datetime):\n            return dt_value.date()\n        if isinstance(dt_value, date):\n            return dt_value\n    try:\n        raw = dtstart.to_ical()\n    except Exception:\n        return None\n    if isinstance(raw, bytes):\n        raw = raw.decode(\"utf-8\")\n    raw = raw.strip()\n    if not raw:\n        return None\n    try:\n        date_part = raw.split(\"T\", 1)[0]\n        return datetime.strptime(date_part, \"%Y%m%d\").date()\n    except Exception:\n        return None\n\ndef sync_to_caldav(events: list[dict], log_lines: list[str]):\n    \"\"\"åŒæ­¥å¤©æ°”äº‹ä»¶åˆ° CalDAV æ—¥å†\"\"\"\n    def log(message: str):\n        log_lines.append(message)\n\n    # è¿æ¥ CalDAV æœåŠ¡å™¨\n    client = caldav.DAVClient(\n        url=CALDAV_URL,\n        username=CALDAV_USERNAME,\n        password=CALDAV_PASSWORD,\n    )\n\n    principal = client.principal()\n\n    # æŸ¥æ‰¾æˆ–åˆ›å»ºæ—¥å†\n    calendar = None\n    for cal in principal.calendars():\n        if cal.name == CALENDAR_NAME:\n            calendar = cal\n            break\n\n    if calendar is None:\n        log(f\"åˆ›å»ºæ—¥å†: {CALENDAR_NAME}\")\n        calendar = principal.make_calendar(name=CALENDAR_NAME)\n\n    log(f\"ä½¿ç”¨æ—¥å†: {calendar.name}\")\n\n    # åˆ é™¤æ—§çš„å¤©æ°”äº‹ä»¶ï¼ˆåŸºäº UID å‰ç¼€ä¸æ—¥æœŸèŒƒå›´ï¼‰\n    today = min((e[\"date\"] for e in events), default=datetime.now().date())\n    keep_since = today - timedelta(days=KEEP_PAST_DAYS)\n\n    existing_events = calendar.events()\n    for ev in existing_events:\n        try:\n            ical = ev.icalendar_component\n            uid = str(ical.get(\"uid\", \"\"))\n            if uid.endswith(\"@weather-calendar\"):\n                ev_date = _extract_event_date(ical)\n                if ev_date is None:\n                    log(f\"è·³è¿‡æœªçŸ¥æ—¥æœŸäº‹ä»¶: {ical.get('summary', 'Unknown')}\")\n                    continue\n\n                if ev_date < keep_since:\n                    log(f\"åˆ é™¤è¿‡æœŸäº‹ä»¶: {ev_date} - {ical.get('summary', 'Unknown')}\")\n                    ev.delete()\n                elif ev_date >= today:\n                    log(f\"æ›´æ–°äº‹ä»¶(å…ˆåˆ é™¤): {ev_date} - {ical.get('summary', 'Unknown')}\")\n                    ev.delete()\n                else:\n                    log(f\"ä¿ç•™å†å²äº‹ä»¶: {ev_date} - {ical.get('summary', 'Unknown')}\")\n        except Exception as e:\n            log(f\"å¤„ç†äº‹ä»¶æ—¶å‡ºé”™: {e}\")\n\n    # åˆ›å»ºæ–°äº‹ä»¶\n    for weather in events:\n        event = create_ical_event(weather)\n\n        cal = Calendar()\n        cal.add(\"prodid\", \"-//Weather Calendar//weather-sync//CN\")\n        cal.add(\"version\", \"2.0\")\n        cal.add_component(event)\n\n        calendar.save_event(cal.to_ical().decode(\"utf-8\"))\n        log(f\"å·²æ·»åŠ : {weather['date']} - {weather['emoji']} {weather['description']}\")\n\n\ndef main():\n    log_lines: list[str] = []\n\n    def log(message: str):\n        log_lines.append(message)\n\n    data = _items[0][\"json\"]\n    # æå–å¤©æ°”æ•°æ®\n    events = parse_weather_data(data)\n\n    log(\"=\" * 50)\n    log(\"æå–åˆ°çš„å¤©æ°”æ•°æ®:\")\n    log(\"=\" * 50)\n    for e in events:\n        if e[\"temp_min\"] is not None:\n            log(f\"{e['date']} {e['emoji']} {e['description']}: {e['temp_min']:.0f}Â°~{e['temp_max']:.0f}Â°C\")\n        else:\n            log(f\"{e['date']} {e['emoji']} {e['description']}: {e['temp']:.0f}Â°C (å½“å‰)\")\n    log(\"=\" * 50)\n\n    # åŒæ­¥åˆ° CalDAV\n    sync_to_caldav(events, log_lines)\n\n    log(\"âœ… å¤©æ°”æ•°æ®å·²åŒæ­¥åˆ°æ—¥å†!\")\n\n    return log_lines\n\nlogs = main()\nreturn [{\"log\": logs}]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1072, -432],
      "id": "700937f8-8ab3-4543-aa71-ad4ea10de342",
      "name": "Weather to CalDAV",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 30
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [-1776, -240],
      "id": "95c85fa9-17ec-4c07-aec4-b633b1056613",
      "name": "Schedule Trigger"
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Weather to CalDAV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "634c7524-546f-4f80-8ee8-fe343eb47472",
  "meta": {
    "instanceId": "e59a4df5e77282e4102ff4c4504bff81542550c0d6baae2885a1d72299bd16f4"
  },
  "id": "WZKG6nnEgYeL8q5F",
  "tags": []
}
